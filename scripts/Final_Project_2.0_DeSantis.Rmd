---
title: "Intro to Data Science Final Project"
author: "Lucas Adams, Ryan Miles-Ferguson, Sean DeSantis"
output: html_notebook
---

```{r}
library(knitr)
library(tidyverse)
library(janitor)
library(here)
library(sf)
library(tmap)
```

```{r}
capital_bikeshare <- read_csv(here("data_raw", "202309-capitalbikeshare-tripdata.csv"))
```
# Creating new dataframe that takes out any rows with missing information
```{r}
capital_bikeshare_na = na.omit(capital_bikeshare)
```

# Subtracting end time from start time and finding the values where the start time exceeds end time and filtering them out of the data set

```{r}
capital_bikeshare_rt = capital_bikeshare_na %>%
  mutate(ride_time = ended_at-started_at) %>%
  arrange(ride_time) %>%
  filter(ride_time>=0)
  
```

# Combining timestamps into one column
```{r}
capital_bikeshare_rt2 = pivot_longer(capital_bikeshare_rt, cols = c("started_at", "ended_at"), values_to = "time")
```

# New Variable for Start and End
```{r}
capital_bikeshare_rt3 = capital_bikeshare_rt2 %>%
  mutate(time_type = case_when(
  time %in% capital_bikeshare_na$started_at ~ "start",       
  time %in% capital_bikeshare_na$ended_at ~ "end",       
  ))
```

# Counts how many times a bike started at a station
```{r}
bikeshare_rt_count_start = capital_bikeshare_rt3 %>%
  group_by(start_station_id, start_station_name, .drop = FALSE) %>%
  count(time_type = "start", name = "bikes_start") 
print(bikeshare_rt_count_start)
```

# Counts how many times a bike ended at a station
```{r}
bikeshare_rt_count_end = capital_bikeshare_rt3 %>%
  group_by(end_station_id, end_station_name, .drop = FALSE) %>%
 count(time_type = "end", name = "bikes_end")

print(bikeshare_rt_count_end)
```
# Combines counts into one dataframe and computes the net gain of bikes at a station
```{r}
bikeshare_rt_net_gain=bind_cols(bikeshare_rt_count_start,bikeshare_rt_count_end) %>%
  mutate(net_gain = bikes_end - bikes_start) %>%
arrange(net_gain) 

print(bikeshare_rt_net_gain)
```

# We'll pause with this for a minute, as we need to be able to map everything first. First, we are going to load in the data for the location of each metro station and bikeshare dock.
```{r}
bikeshare=st_read(here("data_raw","Capital_Bikeshare_Locations.geojson"))
```

```{r}
metro = st_read(here("data_raw", "Metro_Stations_Regional.geojson"))
```

# Now, we'll plot the data just to get a quick sense of what everything looks like.
```{r}
plot(metro)
```

```{r}
plot(bikeshare)
```

# Next, we'll merge the location data to be able to effectively plot it.
```{r}
bikeshare_j=bind_rows(bikeshare,metro)
```

# When the data is merged, the station type (metro/bikeshare) is lost, so we'll use the OBJECTID to be able to identify each.
```{r}
bikeshare_metro = bikeshare_j %>% mutate(loc_type = case_when(
  OBJECTID <= 1000 ~ "Metro",
  OBJECTID > 1000 ~ "Bikeshare"
))
```

# Now we will plot the location of each metro station and each bikeshare dock using the tmap package.
```{r}
tmap_mode("view")
tm_shape(bikeshare_metro) + tm_dots("loc_type") + tm_text("NUM_BIKES_AVAILABLE",size = 0.5)
```

# Now that we have a good idea of where the stations are, we'll join the ridership data for each bikeshare station with the location data for the bikeshare data only.
```{r}
#bikeshare_rt_net_gain = bikeshare_rt_net_gain %>% rename(NAME = start_station_name)
bikeshare_squared = left_join(bikeshare, bikeshare_rt_net_gain, by = "NAME")
```

```{r}
bikeshare_squared_b = bikeshare_squared  %>%
  select(-STATION_STATUS, -GIS_ID) %>% drop_na()
#bikeshare_squared_b = na.omit(bikeshare_squared2)
```

```{r}
tmap_mode("view")
tm_shape(bikeshare_squared_b) + tm_dots("NAME", legend.show = FALSE) + tm_text("net_gain",size = 0.5)
```

```{r}
bikeshare_1000 = bikeshare_squared_b %>% filter(net_gain >= 0)
tmap_mode("view")
tm_shape(bikeshare_1000) + tm_dots("NAME", legend.show = FALSE) + tm_text("net_gain",size = 0.5)
```

```{r}
bikeshare_metro_1000 = bind_rows(bikeshare_1000, metro)
bikeshare_metro_1000 = bikeshare_metro_1000 %>% mutate(loc_type = case_when(
  OBJECTID <= 1000 ~ "Metro",
  OBJECTID > 1000 ~ "Bikeshare"
))
tmap_mode("view")
tm_shape(bikeshare_metro_1000) + tm_dots("loc_type") + tm_text("net_gain")
```

```{r}
bikeshare_net_negative = bikeshare_squared_b %>% filter(net_gain <= 0)
bikeshare_metro_net_negative = bind_rows(bikeshare_net_negative, metro)
bikeshare_metro_net_negative = bikeshare_metro_net_negative %>% mutate(loc_type = case_when(
  OBJECTID <= 1000 ~ "Metro",
  OBJECTID > 1000 ~ "Bikeshare"
))
tmap_mode("view")
tm_shape(bikeshare_metro_net_negative) + tm_dots("loc_type") + tm_text("net_gain")
```

