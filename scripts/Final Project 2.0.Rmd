---
title: "Intro to Data Science Final Project"
author: "Lucas Adams, Ryan Miles-Ferguson, Sean DeSantis"
output: html_notebook
---

```{r}
library(knitr)
library(tidyverse)
library(janitor)
library(here)
library(sf)
library(tmap)
```

```{r}
df1 <- read_csv(here("data_raw", "202309-capitalbikeshare-tripdata.csv"))
```
# Creating new dataframe that takes out any rows with missing information
```{r}
df1b = na.omit(df1)
```

# Subtracting end time from start time and finding the values where the start time exceeds end time and filtering them out of the data set

```{r}
dfb = df1b %>%
  mutate(ride_time = ended_at-started_at) %>%
  arrange(ride_time) %>%
  filter(ride_time>=0)
  
```

# Combining timestamps into one column
```{r}
df2b = pivot_longer(dfb, cols = c("started_at", "ended_at"), values_to = "time")
```

# New Variable for Start and End
```{r}
df3b = df2b %>%
  mutate(time_type = case_when(
  time %in% df1b$started_at ~ "start",       
  time %in% df1b$ended_at ~ "end",       
  ))
```

# Counts how many times a bike started at a station
```{r}
df_count_start = df3b %>%
  group_by(start_station_id, start_station_name, .drop = FALSE) %>%
  count(time_type = "start", name = "bikes_start") 
print(df_count_start)
```


# We'll pause with this for a minute, as we need to be able to map everything first. First, we are going to load in the data for the location of each metro station and bikeshare dock.
```{r}
bikeshare=st_read(here("data_raw","Capital_Bikeshare_Locations.geojson"))
```

```{r}
metro = st_read(here("data_raw", "Metro_Stations_Regional.geojson"))
```

# Now, we'll plot the data just to get a quick sense of what everything looks like.
```{r}
plot(metro)
```

```{r}
plot(bikeshare)
```

# Next, we'll merge the location data to be able to effectively plot it.
```{r}
bikeshare_j=bind_rows(bikeshare,metro)
```

# When the data is merged, the station type (metro/bikeshare) is lost, so we'll use the OBJECTID to be able to identify each.
```{r}
bikeshare_metro = bikeshare_j %>% mutate(loc_type = case_when(
  OBJECTID <= 1000 ~ "Metro",
  OBJECTID > 1000 ~ "Bikeshare"
))
```

# Now we will plot the location of each metro station and each bikeshare dock using the tmap package.
```{r}
tmap_mode("view")
tm_shape(bikeshare_metro) + tm_dots("loc_type")
```

# Now that we have a good idea of where the stations are, we'll join the ridership data for each bikeshare station with the location data for the bikeshare data only.
```{r}
bikeshare1 = st_as_sf(df_count_start, crs = 4326)
bikeshare_squared = bind_rows(bikeshare, bikeshare1)
```

